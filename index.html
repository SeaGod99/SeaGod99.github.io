<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="FFXIV å³æ™‚å¸‚å ´æŸ¥è©¢å·¥å…·">
    <meta name="keywords" content="FFXIV,æœ€çµ‚å¹»æƒ³,å¸‚å ´,Universalis">
    <title>FFXIV å¸‚å ´æŸ¥è©¢å·¥å…·</title>
    <link rel="stylesheet" href="assets/css/jquery-ui.min.css">
    <link rel="stylesheet" href="assets/css/jquery-ui.structure.min.css">
    <link rel="stylesheet" href="assets/css/jquery-ui.theme.min.css">
    <style>
        :root {
            --primary: #667eea;
            --primary-dark: #764ba2;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --info: #17a2b8;
            --light: #f8f9fa;
            --dark: #333;
            --gray: #6c757d;
            --border-color: #dee2e6;
            --shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
            --radius: 0.375rem;
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
            -webkit-font-smoothing: antialiased;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            font-size: 1rem;
            line-height: 1.5;
            color: var(--dark);
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            min-height: 100vh;
            padding: 1rem;
        }

        .page-container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .page-header {
            text-align: center;
            color: white;
            margin-bottom: 2rem;
            padding: 2rem 0;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 0.75rem;
        }

        .page-header h1 {
            font-size: clamp(1.5rem, 5vw, 3rem);
            margin-bottom: 0.5rem;
            font-weight: 700;
        }

        .page-header p {
            font-size: 1.1rem;
            opacity: 0.9;
            margin-bottom: 1rem;
        }

        .server-badge {
            display: inline-block;
            background: rgba(255, 255, 255, 0.2);
            padding: 0.5rem 1rem;
            border-radius: var(--radius);
            font-weight: 600;
            color: white;
        }

        .badge-link {
            color: white;
            cursor: pointer;
            opacity: 0.8;
            text-decoration: underline;
            margin-left: 0.5rem;
        }

        .badge-link:hover {
            opacity: 1;
        }

        .main-content {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .panel {
            background: white;
            border-radius: 0.75rem;
            box-shadow: var(--shadow);
            overflow: hidden;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
            }
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
        }

        .panel-header h3 {
            font-size: 1.1rem;
            margin: 0;
        }

        .btn-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .btn-close:hover {
            opacity: 0.8;
        }

        .panel-body {
            padding: 1.5rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            font-size: 0.95rem;
        }

        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            font-size: 1rem;
            transition: var(--transition);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .input-group {
            display: flex;
            gap: 0.5rem;
        }

        .input-group input {
            flex: 1;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: var(--radius);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
        }

        .btn-block {
            width: 100%;
        }

        .form-text {
            display: block;
            margin-top: 0.25rem;
            font-size: 0.85rem;
            color: var(--gray);
        }

        .alert {
            padding: 1rem;
            border-radius: var(--radius);
            margin-bottom: 1rem;
        }

        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .results-header {
            margin-bottom: 1rem;
        }

        .results-header strong {
            color: var(--primary);
        }

        .results-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            max-height: 500px;
            overflow-y: auto;
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            background: var(--light);
            border-radius: var(--radius);
            border-left: 4px solid var(--primary);
            transition: var(--transition);
        }

        .result-item:hover {
            background: #e8eaf6;
        }

        .result-icon {
            width: 40px;
            height: 40px;
            border-radius: 0.5rem;
            margin-right: 0.75rem;
            object-fit: cover;
            background: #e9ecef;
            border: 1px solid #e0e0e0;
            flex-shrink: 0;
        }

        .result-details {
            flex: 1;
        }

        .result-name {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .result-meta {
            font-size: 0.85rem;
            color: var(--gray);
        }

        .result-id {
            margin-right: 0.5rem;
        }

        .result-category {
            display: inline-block;
            margin-left: 0.5rem;
            padding: 0.2rem 0.4rem;
            background: var(--warning);
            color: var(--dark);
            border-radius: 0.25rem;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .result-level {
            display: inline-block;
            margin-left: 0.5rem;
            padding: 0.2rem 0.4rem;
            background: var(--info);
            color: white;
            border-radius: 0.25rem;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .item-result-btn {
            margin-left: auto;
        }

        /* è·æ¥­ç¯©é¸æ¨£å¼ */
        .job-filter-container {
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: var(--radius);
            border-left: 4px solid var(--primary);
            display: none;
        }

        .job-filter-container.active {
            display: block;
        }

        .job-filter-container label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            font-size: 0.95rem;
            color: var(--dark);
        }

        .job-filter-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .filter-btn {
            padding: 0.4rem 0.8rem;
            background: white;
            border: 2px solid var(--border-color);
            border-radius: var(--radius);
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--dark);
            transition: var(--transition);
            white-space: nowrap;
        }

        .filter-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
            background: rgba(102, 126, 234, 0.1);
        }

        .filter-btn-active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
            box-shadow: 0 0.25rem 0.5rem rgba(102, 126, 234, 0.3);
        }

        .info-row {
            display: flex;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border-color);
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-row .label {
            font-weight: 600;
            width: 150px;
            color: var(--gray);
        }

        .info-row .value {
            flex: 1;
            word-break: break-word;
        }

        .price-row {
            margin-bottom: 1.5rem;
        }

        .price-type {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--primary);
        }

        .price-row div {
            margin-bottom: 0.25rem;
            font-size: 0.95rem;
        }

        .message-container {
            position: fixed;
            top: 2rem;
            right: 2rem;
            z-index: 2000;
            max-width: 400px;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1999;
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .loading-overlay p {
            color: white;
            font-weight: 600;
        }

        .page-footer {
            text-align: center;
            color: white;
            margin-top: 3rem;
            padding: 2rem;
            opacity: 0.8;
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 0.5rem;
            }

            .page-header {
                padding: 1.5rem 1rem;
            }

            .main-content {
                gap: 1rem;
            }

            .message-container {
                right: 1rem;
                left: 1rem;
                max-width: none;
            }
        }
    </style>
</head>

<body>
    <div class="page-container">
        <!-- é é¢é ­éƒ¨ -->
        <header class="page-header">
            <h1>âš”ï¸ FFXIV å¸‚å ´æŸ¥è©¢</h1>
            <p>å³æ™‚æŸ¥è©¢æœ€çµ‚å¹»æƒ³ XIV å¸‚å ´æ¿åƒ¹æ ¼å’Œæ•¸æ“š</p>
            <div class="server-badge">
                <span id="serverBadge">æœªé¸æ“‡ä¼ºæœå™¨</span>
                <span id="languageBadge"></span>
                <a href="javascript:resetServerSelection()" class="badge-link">åˆ‡æ›</a>
            </div>
        </header>

        <!-- ä¸»å…§å®¹å€ -->
        <main class="main-content">
            <!-- å·¦å´æ¬„ï¼šæŸ¥è©¢é¢æ¿ -->
            <div class="sidebar sidebar-left">
                <!-- æ•¸æ“šä¸­å¿ƒå’Œä¼ºæœå™¨é¸æ“‡ -->
                <section class="panel" id="serverSelectPanel">
                    <div class="panel-header">
                        <h3>ğŸŒ ä¼ºæœå™¨é¸æ“‡</h3>
                    </div>
                    <div class="panel-body">
                        <div class="form-group">
                            <label for="dcSelect">æ•¸æ“šä¸­å¿ƒ</label>
                            <select id="dcSelect" class="form-control">
                                <option value="">-- é¸æ“‡æ•¸æ“šä¸­å¿ƒ --</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="worldSelect">ä¼ºæœå™¨</label>
                            <select id="worldSelect" class="form-control" disabled>
                                <option value="">-- å…ˆé¸æ“‡æ•¸æ“šä¸­å¿ƒ --</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="languageSelect">æœå°‹èªè¨€</label>
                            <select id="languageSelect" class="form-control">
                                <option value="tc" selected>ç¹é«”ä¸­æ–‡</option>
                                <option value="en">English (è‹±æ–‡)</option>
                            </select>
                            <small class="form-text">é¸æ“‡æœå°‹æ™‚ä½¿ç”¨çš„èªè¨€</small>
                        </div>

                        <button id="confirmBtn" class="btn btn-primary btn-block" disabled>
                            âœ“ ç¢ºèªä¼ºæœå™¨
                        </button>
                    </div>
                </section>


                <!-- ç‰©å“æœå°‹ -->
                <section class="panel" id="searchPanel" style="display: none;">
                    <div class="panel-header">
                        <h3>ğŸ” ç‰©å“æœå°‹</h3>
                    </div>
                    <div class="panel-body">
                        <div class="form-group">
                            <label for="searchQuery">ç‰©å“åç¨±</label>
                            <div class="input-group">
                                <input type="text" id="searchQuery" class="form-control" placeholder="è¼¸å…¥ç‰©å“åç¨±æœå°‹...">
                                <button class="btn btn-primary btn-small" onclick="searchItemByName()">æœå°‹</button>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- ç‰©å“ ID æŸ¥è©¢ -->
                <section class="panel" id="idSearchPanel" style="display: none;">
                    <div class="panel-header">
                        <h3>ğŸ†” æŒ‰ ID æŸ¥è©¢</h3>
                    </div>
                    <div class="panel-body">
                        <div class="form-group">
                            <label for="itemIdInput">ç‰©å“ ID</label>
                            <input type="number" id="itemIdInput" class="form-control" placeholder="è¼¸å…¥ç‰©å“ ID" min="1">
                        </div>
                        <button class="btn btn-primary btn-block" onclick="queryItemById()">
                            æŸ¥è©¢è©³ç´°ä¿¡æ¯
                        </button>
                    </div>
                </section>
            </div>

            <!-- å³å´æ¬„ï¼šçµæœå±•ç¤º -->
            <div class="sidebar sidebar-right">
                <!-- æœå°‹çµæœå¡ -->
                <section class="panel" id="searchResultsPanel" style="display: none;">
                    <div class="panel-header">
                        <h3>ğŸ” æœå°‹çµæœ</h3>
                        <button class="btn-close" onclick="clearSearchResults()">Ã—</button>
                    </div>
                    <div class="panel-body">
                        <div id="searchResultsHeader" class="results-header">
                            <span>æ‰¾åˆ° <strong id="resultCount">0</strong> å€‹ç‰©å“</span>
                        </div>
                        <div id="jobFilterContainer" class="job-filter-container">
                            <label>è·æ¥­ç¯©é¸</label>
                            <div id="jobFilterButtons" class="job-filter-buttons"></div>
                        </div>
                        <div id="resultsList" class="results-list"></div>
                    </div>
                </section>

                <!-- ç‰©å“ä¿¡æ¯å¡ -->
                <section class="panel" id="itemInfoPanel" style="display: none;">
                    <div class="panel-header">
                        <h3 id="itemTitle">ç‰©å“ä¿¡æ¯</h3>
                        <button class="btn-close" onclick="clearItemInfo()">Ã—</button>
                    </div>
                    <div class="panel-body">
                        <div id="itemInfoContent" class="item-info"></div>
                    </div>
                </section>

                <!-- åƒ¹æ ¼ä¿¡æ¯å¡ -->
                <section class="panel" id="pricePanel" style="display: none;">
                    <div class="panel-header">
                        <h3>ğŸ“Š åƒ¹æ ¼ä¿¡æ¯</h3>
                    </div>
                    <div class="panel-body">
                        <div id="priceContent" class="price-grid"></div>
                    </div>
                </section>

                <!-- åˆæˆè¡¨å¡ -->
                <section class="panel" id="craftPanel" style="display: none;">
                    <div class="panel-header">
                        <h3>ğŸ”¨ åˆæˆè¡¨</h3>
                    </div>
                    <div class="panel-body">
                        <div id="craftContent" class="recipes-container"></div>
                    </div>
                </section>

                <!-- è£½é€ æˆæœ¬å¡ -->
                <section class="panel" id="craftingCostPanel" style="display: none;">
                    <div class="panel-header">
                        <h3>ğŸ’° è£½é€ æˆæœ¬è¨ˆç®—</h3>
                    </div>
                    <div class="panel-body">
                        <div class="form-group">
                            <label for="craftQuantity">è£½é€ æ•¸é‡</label>
                            <input type="number" id="craftQuantity" class="form-control" value="1" min="1">
                        </div>
                        <button class="btn btn-primary btn-block" onclick="calculateCraftingCost()">
                            è¨ˆç®—æˆæœ¬
                        </button>
                        <div id="craftingCostContent" style="margin-top: 1rem;"></div>
                    </div>
                </section>
            </div>
        </main>

        <!-- åŠ è¼‰æŒ‡ç¤ºå™¨ -->
        <div id="globalLoading" class="loading-overlay" style="display: none;">
            <div>
                <div class="spinner"></div>
                <p>æŸ¥è©¢ä¸­...</p>
            </div>
        </div>

        <!-- å…¨å±€æ¶ˆæ¯æç¤º -->
        <div id="messageContainer" class="message-container"></div>
    </div>

    <!-- è…³éƒ¨ -->
    <footer class="page-footer">
        <p>Â© 2026 FFXIV å¸‚å ´æŸ¥è©¢å·¥å…· | ç”± Universalis API æä¾›æ•¸æ“š</p>
        <p><small>æ­¤å·¥å…·èˆ‡ Square Enix ç„¡é—œã€‚FINAL FANTASY XIV Â© Square Enix</small></p>
    </footer>

    <!-- jQuery -->
    <script src="assets/js/jquery-4.0.0.min.js"></script>
    <script src="assets/js/jquery-ui.min.js"></script>

    <script>
        // ==================== å…¨å±€ç‹€æ…‹ ====================
        const state = {
            selectedServer: localStorage.getItem('selectedServer') || null,
            selectedDatacenter: localStorage.getItem('selectedDatacenter') || null,
            selectedLanguage: localStorage.getItem('selectedLanguage') || 'tc',
            isLoading: false,
            serversByDC: null,
            datacenters: null,
            isDataLoaded: false,
            isDatacentersLoaded: false,
            isWorldsLoaded: false,
            lastItemPriceData: null
        };

        let fullSearchResults = [];
        let currentJobFilter = 'ALL';

        // ==================== é…ç½® ====================
        const config = {
            xivApiUrl: 'https://xivapi.com',
            universalisUrl: 'https://universalis.app/api/v2',
            timeout: 15000
        };

        const DEFAULT_ICON = 'data:image/gif;base64,R0lGODlhAQABAAAAACw=';

        // ==================== åˆå§‹åŒ– ====================
        $(document).ready(function () {
            console.log('jQuery ready');
            initializeApp();

            // åœ¨ç‰©å“æœå°‹è¼¸å…¥æ¡†æŒ‰ä¸‹ Enter ç›´æ¥è§¸ç™¼æœå°‹
            $('#searchQuery').on('keydown', function (e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    searchItemByName();
                }
            });
        });

        function initializeApp() {
            console.log('=== FFXIV å¸‚å ´æŸ¥è©¢å·¥å…· - åˆå§‹åŒ–é–‹å§‹ ===');
            console.log('ğŸ“¦ LocalStorage ç‹€æ…‹:');
            console.log('  - selectedServer:', state.selectedServer);
            console.log('  - selectedDatacenter:', state.selectedDatacenter);
            console.log('  - selectedLanguage:', state.selectedLanguage);

            // ç„¡è«–å¦‚ä½•éƒ½å…ˆé åŠ è¼‰æ•¸æ“šä¸­å¿ƒå’Œä¼ºæœå™¨æ•¸æ“š
            console.log('ğŸš€ é–‹å§‹é åŠ è¼‰æ•¸æ“šä¸­å¿ƒå’Œä¼ºæœå™¨åˆ—è¡¨...');
            loadAllDataInBackground();

            if (state.selectedServer && state.selectedDatacenter) {
                console.log('âœ“ æ‰¾åˆ°å·²ä¿å­˜çš„ä¼ºæœå™¨é…ç½®ï¼Œç›´æ¥é€²å…¥ä¸»é é¢');
                showMainContent();
            } else {
                console.log('â„¹ æœªæ‰¾åˆ°ä¼ºæœå™¨é…ç½®ï¼Œé¡¯ç¤ºé¸æ“‡é¢æ¿');
            }

            showServerSelectionPanel();
        }

        // åœ¨èƒŒæ™¯åŠ è¼‰æ•¸æ“šï¼ˆä¸é˜»å¡UIï¼‰
        function loadAllDataInBackground() {
            console.log('èƒŒæ™¯åŠ è¼‰æ•¸æ“šä¸­å¿ƒå’Œä¼ºæœå™¨åˆ—è¡¨...');

            let datacentersData = null;
            let worldsData = null;

            // åŒæ™‚è«‹æ±‚å…©å€‹ API
            Promise.all([
                // è«‹æ±‚æ•¸æ“šä¸­å¿ƒåˆ—è¡¨
                $.ajax({
                    url: 'https://universalis.app/api/v2/data-centers',
                    type: 'GET',
                    dataType: 'json',
                    timeout: 10000
                }).then(response => {
                    console.log('âœ“ æ•¸æ“šä¸­å¿ƒ API å®Œæˆ');
                    datacentersData = Array.isArray(response) ? response : (response.datacenters || []);
                    return datacentersData;
                }).catch(error => {
                    console.warn('æ•¸æ“šä¸­å¿ƒ API å¤±æ•—:', error);
                    return null;
                }),

                // è«‹æ±‚ä¼ºæœå™¨åˆ—è¡¨
                $.ajax({
                    url: 'https://universalis.app/api/v2/worlds',
                    type: 'GET',
                    dataType: 'json',
                    timeout: 10000
                }).then(response => {
                    console.log('âœ“ ä¼ºæœå™¨ API å®Œæˆ');
                    worldsData = response;
                    return response;
                }).catch(error => {
                    console.warn('ä¼ºæœå™¨ API å¤±æ•—:', error);
                    return null;
                })
            ]).then(() => {
                // å…©å€‹ API éƒ½å®Œæˆäº†
                if (datacentersData && datacentersData.length > 0) {
                    state.datacenters = datacentersData;
                    state.isDatacentersLoaded = true;
                    console.log('âœ“ æ•¸æ“šä¸­å¿ƒæ•¸æ“šå·²ç·©å­˜:', datacentersData.length, 'å€‹');
                }

                if (worldsData && Array.isArray(worldsData) && worldsData.length > 0) {
                    // ä½¿ç”¨ ID åŒ¹é…æ–¹å¼æ§‹å»ºæ˜ å°„
                    if (datacentersData && datacentersData.length > 0) {
                        buildServersByDCMapWithIDs(datacentersData, worldsData);
                    } else {
                        buildServersByDCMapWithNames(worldsData);
                    }
                    state.isWorldsLoaded = true;
                    console.log('âœ“ ä¼ºæœå™¨æ•¸æ“šå·²ç·©å­˜:', Object.keys(state.serversByDC || {}).length, 'å€‹æ•¸æ“šä¸­å¿ƒ');
                }

                state.isDataLoaded = true;
                console.log('âœ… æ‰€æœ‰æ•¸æ“šåŠ è¼‰å®Œæˆä¸¦å·²ç·©å­˜');
            });
        }

        // é¡¯ç¤ºä¼ºæœå™¨é¸æ“‡é¢æ¿
        function showServerSelectionPanel() {
            console.log('é¡¯ç¤ºä¼ºæœå™¨é¸æ“‡é¢æ¿');

            // å¦‚æœæ•¸æ“šå·²åŠ è¼‰ï¼Œç›´æ¥æ¸²æŸ“
            if (state.isDataLoaded && state.datacenters) {
                renderDatacenterOptions(state.datacenters);
                $('#dcSelect').prop('disabled', false);
            } else {
                // ç­‰å¾…æ•¸æ“šåŠ è¼‰
                $('#dcSelect').prop('disabled', true).html('<option value="">-- è¼‰å…¥ä¸­... --</option>');

                // ç›£è½æ•¸æ“šåŠ è¼‰å®Œæˆ
                const checkInterval = setInterval(() => {
                    if (state.isDataLoaded && state.datacenters) {
                        clearInterval(checkInterval);
                        renderDatacenterOptions(state.datacenters);
                        $('#dcSelect').prop('disabled', false);
                        showMessage('æ•¸æ“šåŠ è¼‰å®Œæˆï¼Œè«‹é¸æ“‡ä¼ºæœå™¨', 'success');
                    }
                }, 100);
            }

            // ç¶å®šäº‹ä»¶
            bindServerSelectionEvents();
        }

        // ç¶å®šä¼ºæœå™¨é¸æ“‡äº‹ä»¶
        function bindServerSelectionEvents() {
            // ç¶å®šæ•¸æ“šä¸­å¿ƒé¸æ“‡äº‹ä»¶
            $('#dcSelect').off('change').on('change', function () {
                const dc = $(this).val();
                console.log('æ•¸æ“šä¸­å¿ƒé¸æ“‡è®ŠåŒ–:', dc);

                if (dc) {
                    loadServersByDatacenter(dc);
                } else {
                    resetServerSelect();
                }
            });

            // ç¶å®šä¼ºæœå™¨é¸æ“‡äº‹ä»¶
            $('#worldSelect').off('change').on('change', function () {
                const world = $(this).val();
                $('#confirmBtn').prop('disabled', !world);
            });

            // ç¶å®šç¢ºèªæŒ‰éˆ•äº‹ä»¶
            $('#confirmBtn').off('click').on('click', function () {
                confirmServerSelection();
            });
        }

        // ==================== ä¼ºæœå™¨é¸æ“‡ç›¸é—œå‡½æ•¸ ====================

        // æ¸²æŸ“æ•¸æ“šä¸­å¿ƒé¸é …
        function renderDatacenterOptions(datacenters) {
            let html = '<option value="">-- é¸æ“‡æ•¸æ“šä¸­å¿ƒ --</option>';

            // ç¢ºä¿æ•¸æ“šæ ¼å¼æ­£ç¢º
            if (!Array.isArray(datacenters)) {
                console.error('æ•¸æ“šä¸­å¿ƒæ ¼å¼éŒ¯èª¤:', datacenters);
                return;
            }

            datacenters.sort((a, b) => {
                const nameA = a.name || a;
                const nameB = b.name || b;
                return nameA.localeCompare(nameB);
            });

            datacenters.forEach(dc => {
                const name = dc.name || dc;
                const region = dc.region || '';
                if (region) {
                    html += `<option value="${escapeHtml(name)}">${escapeHtml(name)} (${escapeHtml(region)})</option>`;
                } else {
                    html += `<option value="${escapeHtml(name)}">${escapeHtml(name)}</option>`;
                }
            });

            $('#dcSelect').html(html);
            console.log('æ•¸æ“šä¸­å¿ƒé¸é …å·²æ›´æ–°ï¼Œå…±', datacenters.length, 'å€‹');
        }

        // æ§‹å»ºæ•¸æ“šä¸­å¿ƒ->ä¼ºæœå™¨æ˜ å°„è¡¨ï¼ˆä½¿ç”¨IDåŒ¹é… - æ­£ç¢ºæ–¹å¼ï¼‰
        function buildServersByDCMapWithIDs(datacenters, worlds) {
            console.log('=== ä½¿ç”¨ ID åŒ¹é…æ–¹å¼æ§‹å»ºæ˜ å°„è¡¨ ===');

            // å…ˆå»ºç«‹ world ID -> world name çš„æ˜ å°„
            const worldIdToName = {};
            worlds.forEach(world => {
                if (world.id && world.name) {
                    worldIdToName[world.id] = world.name;
                }
            });

            console.log('ä¸–ç•ŒIDæ˜ å°„è¡¨:', Object.keys(worldIdToName).length, 'å€‹ä¸–ç•Œ');

            // æ ¹æ“šæ•¸æ“šä¸­å¿ƒçš„ worlds ID åˆ—è¡¨æ§‹å»ºæ˜ å°„
            const newServersByDC = {};
            let totalServers = 0;

            datacenters.forEach(dc => {
                const dcName = dc.name;
                const worldIds = dc.worlds || [];

                if (dcName && Array.isArray(worldIds) && worldIds.length > 0) {
                    newServersByDC[dcName] = [];

                    worldIds.forEach(worldId => {
                        const worldName = worldIdToName[worldId];
                        if (worldName) {
                            newServersByDC[dcName].push(worldName);
                            totalServers++;
                        }
                    });

                    // æ’åº
                    newServersByDC[dcName].sort();
                }
            });

            if (totalServers > 0) {
                state.serversByDC = newServersByDC;
                console.log('âœ“ ä½¿ç”¨IDåŒ¹é…æˆåŠŸæ§‹å»ºæ˜ å°„è¡¨');
                console.log('- æ•¸æ“šä¸­å¿ƒæ•¸é‡:', Object.keys(newServersByDC).length);
                console.log('- ä¼ºæœå™¨ç¸½æ•¸:', totalServers);
                console.log('- è©³ç´°æ˜ å°„:', state.serversByDC);
            } else {
                console.warn('IDåŒ¹é…å¤±æ•—ï¼Œä¿ç•™å‚™ç”¨åˆ—è¡¨');
            }
        }

        // æ§‹å»ºæ•¸æ“šä¸­å¿ƒ->ä¼ºæœå™¨æ˜ å°„è¡¨ï¼ˆä½¿ç”¨åç¨±åŒ¹é… - å‚™ç”¨æ–¹å¼ï¼‰
        function buildServersByDCMapWithNames(worlds) {
            console.log('=== ä½¿ç”¨åç¨±åŒ¹é…æ–¹å¼æ§‹å»ºæ˜ å°„è¡¨ ===');

            // å…ˆä¿ç•™å‚™ç”¨åˆ—è¡¨
            const fallbackServers = state.serversByDC;
            const newServersByDC = {};

            // ä½¿ç”¨ dataCenter å±¬æ€§åˆ†çµ„
            let successCount = 0;
            worlds.forEach(world => {
                const dc = world.dataCenter || world.datacenter;  // æ”¯æ´å…©ç¨®æ ¼å¼
                const serverName = world.name;

                if (dc && serverName) {
                    if (!newServersByDC[dc]) {
                        newServersByDC[dc] = [];
                    }
                    newServersByDC[dc].push(serverName);
                    successCount++;
                }
            });

            // å¦‚æœæˆåŠŸè§£æäº†æ•¸æ“šï¼Œä½¿ç”¨æ–°æ•¸æ“šï¼Œå¦å‰‡ä¿ç•™å‚™ç”¨æ•¸æ“š
            if (successCount > 0) {
                state.serversByDC = newServersByDC;

                // å°æ¯å€‹æ•¸æ“šä¸­å¿ƒçš„ä¼ºæœå™¨åˆ—è¡¨é€²è¡Œæ’åº
                Object.keys(state.serversByDC).forEach(dc => {
                    state.serversByDC[dc].sort();
                });

                console.log('âœ“ ä½¿ç”¨åç¨±åŒ¹é…æˆåŠŸæ§‹å»ºæ˜ å°„è¡¨');
                console.log('- æ•¸æ“šä¸­å¿ƒæ•¸é‡:', Object.keys(state.serversByDC).length);
                console.log('- ä¼ºæœå™¨ç¸½æ•¸:', successCount);
                console.log('- è©³ç´°æ˜ å°„:', state.serversByDC);
            } else {
                console.warn('åç¨±åŒ¹é…å¤±æ•—ï¼Œä¿ç•™å‚™ç”¨åˆ—è¡¨');
                state.serversByDC = fallbackServers;
            }
        }

        // æ ¹æ“šæ•¸æ“šä¸­å¿ƒåŠ è¼‰ä¼ºæœå™¨åˆ—è¡¨ï¼ˆç›´æ¥å¾é åŠ è¼‰çš„è®Šæ•¸è®€å–ï¼‰
        function loadServersByDatacenter(datacenter) {
            console.log('=== å¾è®Šæ•¸è®€å–ä¼ºæœå™¨åˆ—è¡¨ ===');
            console.log('é¸æ“‡çš„æ•¸æ“šä¸­å¿ƒ:', datacenter);

            if (!datacenter) {
                resetServerSelect();
                return;
            }

            // ç¢ºä¿æ•¸æ“šå·²åŠ è¼‰
            if (!state.isDataLoaded) {
                console.warn('æ•¸æ“šå°šæœªåŠ è¼‰å®Œæˆï¼Œè«‹ç¨å€™');
                showMessage('æ•¸æ“šè¼‰å…¥ä¸­ï¼Œè«‹ç¨å€™...', 'info');
                return;
            }

            // æª¢æŸ¥æ˜ å°„è¡¨
            if (!state.serversByDC || Object.keys(state.serversByDC).length === 0) {
                console.error('ä¼ºæœå™¨æ˜ å°„è¡¨ç‚ºç©º');
                showMessage('ä¼ºæœå™¨æ•¸æ“šç•°å¸¸', 'danger');
                return;
            }

            console.log('å¯ç”¨çš„æ•¸æ“šä¸­å¿ƒåˆ—è¡¨:', Object.keys(state.serversByDC).join(', '));

            // æª¢æŸ¥è©²æ•¸æ“šä¸­å¿ƒæ˜¯å¦æœ‰ä¼ºæœå™¨
            if (!state.serversByDC[datacenter]) {
                console.warn('æ‰¾ä¸åˆ°æ•¸æ“šä¸­å¿ƒ:', datacenter);
                console.log('å˜—è©¦å¤§å°å¯«ä¸æ•æ„ŸåŒ¹é…...');

                // å˜—è©¦å¤§å°å¯«ä¸æ•æ„ŸåŒ¹é…
                const dcLower = datacenter.toLowerCase();
                const matchedDC = Object.keys(state.serversByDC).find(key => key.toLowerCase() === dcLower);

                if (matchedDC) {
                    console.log('æ‰¾åˆ°åŒ¹é…çš„æ•¸æ“šä¸­å¿ƒ:', matchedDC);
                    loadServersByDatacenter(matchedDC);
                    return;
                }

                showMessage(`æ‰¾ä¸åˆ°æ•¸æ“šä¸­å¿ƒ "${datacenter}" çš„ä¼ºæœå™¨\nå¯ç”¨: ${Object.keys(state.serversByDC).join(', ')}`, 'warning');
                resetServerSelect();
                return;
            }

            // æ¸²æŸ“ä¼ºæœå™¨é¸é …
            const servers = state.serversByDC[datacenter];
            console.log('æ‰¾åˆ°ä¼ºæœå™¨åˆ—è¡¨:', servers);

            if (!Array.isArray(servers) || servers.length === 0) {
                console.warn('ä¼ºæœå™¨åˆ—è¡¨ç‚ºç©º');
                showMessage('è©²æ•¸æ“šä¸­å¿ƒæ²’æœ‰å¯ç”¨çš„ä¼ºæœå™¨', 'warning');
                resetServerSelect();
                return;
            }

            let html = '<option value="">-- é¸æ“‡ä¼ºæœå™¨ --</option>';

            servers.forEach(server => {
                html += `<option value="${escapeHtml(server)}">${escapeHtml(server)}</option>`;
            });

            $('#worldSelect').html(html).prop('disabled', false);
            $('#confirmBtn').prop('disabled', true);

            console.log('âœ“ ä¼ºæœå™¨åˆ—è¡¨å·²æ›´æ–°ï¼Œå…±', servers.length, 'å€‹ä¼ºæœå™¨');
        }

        // é‡ç½®ä¼ºæœå™¨é¸æ“‡æ¡†
        function resetServerSelect() {
            $('#worldSelect').html('<option value="">-- å…ˆé¸æ“‡æ•¸æ“šä¸­å¿ƒ --</option>').prop('disabled', true);
            $('#confirmBtn').prop('disabled', true);
        }

        // ç¢ºèªä¼ºæœå™¨é¸æ“‡
        function confirmServerSelection() {
            const datacenter = $('#dcSelect').val();
            const world = $('#worldSelect').val();

            if (!datacenter || !world) {
                showMessage('è«‹é¸æ“‡æ•¸æ“šä¸­å¿ƒå’Œä¼ºæœå™¨', 'warning');
                return;
            }

            // ä¿å­˜é¸æ“‡
            state.selectedDatacenter = datacenter;
            state.selectedServer = world;
            localStorage.setItem('selectedDatacenter', datacenter);
            localStorage.setItem('selectedServer', world);

            console.log('å·²é¸æ“‡:', datacenter, '-', world);
            showMessage(`å·²é¸æ“‡ä¼ºæœå™¨: ${world} (${datacenter})`, 'success');

            // æ›´æ–°é¡¯ç¤º
            updateServerDisplay();

            // é¡¯ç¤ºä¸»åŠŸèƒ½ä»‹é¢
            showMainContent();
        }

        // æ›´æ–°ä¼ºæœå™¨é¡¯ç¤º
        function updateServerDisplay() {
            const server = state.selectedServer || 'æœªé¸æ“‡';
            const datacenter = state.selectedDatacenter || '';
            const language = state.selectedLanguage || 'tc';
            const languageText = language === 'tc' ? 'ç¹ä¸­' : (language === 'en' ? 'EN' : language);

            if (datacenter) {
                $('#serverBadge').text(`${server} (${datacenter})`);
            } else {
                $('#serverBadge').text(server);
            }

            $('#languageBadge').text(`èªè¨€: ${languageText}`);
        }

        // é¡¯ç¤ºä¸»å…§å®¹ï¼ˆéš±è—ä¼ºæœå™¨é¸æ“‡é¢æ¿ï¼‰
        function showMainContent() {
            console.log('é¡¯ç¤ºä¸»å…§å®¹å€åŸŸ');
            $('#serverSelectPanel').hide();
            $('#searchPanel').show();
            $('#idSearchPanel').show();
            updateServerDisplay();
        }

        // é‡ç½®ä¼ºæœå™¨é¸æ“‡ï¼ˆæ¸…é™¤å·²ä¿å­˜çš„è¨­å®šï¼‰
        function resetServerSelection() {
            console.log('é‡ç½®ä¼ºæœå™¨é¸æ“‡');

            // æ¸…é™¤ LocalStorage
            localStorage.removeItem('selectedServer');
            localStorage.removeItem('selectedDatacenter');

            // æ¸…é™¤ç‹€æ…‹
            state.selectedServer = null;
            state.selectedDatacenter = null;

            // é‡ç½®UI
            $('#serverSelectPanel').show();
            $('#searchPanel').hide();
            $('#idSearchPanel').hide();
            $('#dcSelect').val('');
            $('#worldSelect').html('<option value="">-- å…ˆé¸æ“‡æ•¸æ“šä¸­å¿ƒ --</option>').prop('disabled', true);
            $('#confirmBtn').prop('disabled', true);
            $('#serverBadge').text('æœªé¸æ“‡ä¼ºæœå™¨');

            // æ¸…é™¤çµæœé¢æ¿
            clearSearchResults();
            clearItemInfo();

            showMessage('å·²é‡ç½®ä¼ºæœå™¨é¸æ“‡', 'info');
        }

        // ä½¿ç”¨ PHP API æœå°‹ç‰©å“
        function searchItemByName() {
            const query = $('#searchQuery').val().trim();

            if (!query) {
                showMessage('è«‹è¼¸å…¥ç‰©å“åç¨±', 'warning');
                return;
            }

            // èª¿ç”¨åŸæœ‰çš„æœå°‹å‡½æ•¸
            searchItems();
        }

        function searchItems() {
            const query = $('#searchQuery').val().trim();

            if (!query) {
                showMessage('è«‹è¼¸å…¥ç‰©å“åç¨±', 'warning');
                return;
            }

            showGlobalLoading(true);
            const loadingTimeout = setTimeout(function () {
                if (state.isLoading) {
                    showGlobalLoading(false);
                    showMessage('æœå°‹è¶…æ™‚ï¼Œè«‹ç¨å¾Œé‡è©¦', 'warning');
                }
            }, 12000);
            console.log('Searching for item:', query);

            // å–å¾—èªè¨€è¨­å®š
            const language = state.selectedLanguage || 'tc';

            if (language === 'tc') {
                // ç¹é«”ä¸­æ–‡ï¼šä½¿ç”¨ tnze.yyyy.games API
                searchFromTnzeAPI(query).then(items => {
                    clearTimeout(loadingTimeout);
                    showGlobalLoading(false);

                    if (items.length === 0) {
                        showMessage('æœªæ‰¾åˆ°ç¬¦åˆçš„ç‰©å“', 'warning');
                        return;
                    }

                    fullSearchResults = items;
                    displaySearchResults(fullSearchResults);
                }).catch(err => {
                    console.error('Search error:', err);
                    clearTimeout(loadingTimeout);
                    showGlobalLoading(false);
                    showMessage('æœå°‹å¤±æ•—ï¼š' + err.message, 'danger');
                });
            } else {
                // è‹±æ–‡ï¼šä½¿ç”¨ XIVAPI
                searchFromXIVAPI(query, 'en').then(items => {
                    clearTimeout(loadingTimeout);
                    showGlobalLoading(false);

                    if (items.length === 0) {
                        showMessage('æœªæ‰¾åˆ°ç¬¦åˆçš„ç‰©å“', 'warning');
                        return;
                    }

                    fullSearchResults = items;
                    displaySearchResults(fullSearchResults);
                }).catch(err => {
                    console.error('Search error:', err);
                    clearTimeout(loadingTimeout);
                    showGlobalLoading(false);
                    showMessage('æœå°‹å¤±æ•—ï¼š' + err.message, 'danger');
                });
            }
        }

        // å¾ tnze.yyyy.games API æœå°‹ (ç¹é«”ä¸­æ–‡)
        function searchFromTnzeAPI(query) {
            return new Promise((resolve, reject) => {
                const results = [];
                const seenItemIds = new Set();
                let pageId = 0;
                const maxPages = 2;

                function fetchPage() {
                    if (pageId >= maxPages) {
                        resolve(results);
                        return;
                    }

                    const searchName = '%' + query + '%';
                    const url = 'https://tnze.yyyy.games/api/datasource/zh-TW/recipe_table?' + $.param({
                        page_id: pageId,
                        search_name: searchName
                    });

                    $.ajax({
                        url: url,
                        type: 'GET',
                        dataType: 'json',
                        timeout: 8000
                    }).then(response => {
                        if (!response || !response.data || !Array.isArray(response.data) || response.data.length === 0) {
                            resolve(results);
                            return;
                        }

                        response.data.forEach(recipe => {
                            const itemId = parseInt(recipe.item_id) || 0;
                            const itemName = recipe.item_name || '';

                            if (itemId > 0 && itemName && !seenItemIds.has(itemId)) {
                                seenItemIds.add(itemId);
                                results.push({
                                    id: itemId,
                                    name: itemName,
                                    category: recipe.job || 'æœªåˆ†é¡',
                                    level: parseInt(recipe.item_level) || 0,
                                    rarity: 0,
                                    icon: null
                                });
                            }
                        });

                        pageId++;
                        if (pageId >= maxPages) {
                            resolve(results);
                        } else {
                            fetchPage();
                        }
                    }).catch(err => {
                        console.warn('Tnze API ç¬¬', pageId, 'é å¤±æ•—:', err);
                        if (results.length > 0) {
                            resolve(results);
                        } else {
                            reject(new Error('API æŸ¥è©¢å¤±æ•—'));
                        }
                    });
                }

                fetchPage();
            });
        }

        // å¾ XIVAPI æœå°‹ (è‹±æ–‡)
        function searchFromXIVAPI(query, language) {
            return new Promise((resolve, reject) => {
                $.ajax({
                    url: 'https://xivapi.com/search',
                    type: 'GET',
                    data: {
                        indexes: 'item',
                        string: query,
                        language: language
                    },
                    dataType: 'json',
                    timeout: 10000
                }).then(response => {
                    if (!response.Results || response.Results.length === 0) {
                        resolve([]);
                        return;
                    }

                    const items = response.Results.map(result => ({
                        id: result.ID,
                        name: result.Name,
                        category: (result.ItemSearchCategory && result.ItemSearchCategory.Name) || 'Uncategorized',
                        level: result.LevelItem || 0,
                        rarity: result.Rarity || 0,
                        icon: result.Icon || null
                    }));

                    resolve(items);
                }).catch(err => {
                    reject(err);
                });
            });
        }

        function displaySearchResults(items) {
            fullSearchResults = Array.isArray(items) ? items : [];
            currentJobFilter = 'ALL';

            renderJobFilter(fullSearchResults);
            renderResultsList(getFilteredResults());
            $('#searchResultsPanel').show();
            showMessage('æœå°‹å®Œæˆï¼Œæ‰¾åˆ° ' + fullSearchResults.length + ' å€‹ç‰©å“', 'success');
        }

        function renderResultsList(items) {
            $('#resultCount').text(items.length);

            let html = '';
            items.forEach(function (item) {
                let categoryHtml = item.category ? '<span class="result-category">' + escapeHtml(item.category) + '</span>' : '';
                let levelHtml = item.level ? '<span class="result-level">LV: ' + item.level + '</span>' : '';

                html += '<div class="result-item">';
                html += '<div class="result-details">';
                html += '<div class="result-name">' + escapeHtml(item.name) + '</div>';
                html += '<div class="result-meta">';
                html += '<span class="result-id">ID: ' + item.id + '</span>';
                html += categoryHtml;
                html += levelHtml;
                html += '</div></div>';
                html += '<button class="btn btn-small btn-primary item-result-btn" onclick="queryItemById(' + item.id + ')">æŸ¥è©¢</button>';
                html += '</div>';
            });

            $('#resultsList').html(html);
        }

        function renderJobFilter(items) {
            const categoryMap = new Map();

            (items || []).forEach(item => {
                const category = (item.category || '').trim();
                if (category) {
                    const key = category.toLowerCase();
                    const existing = categoryMap.get(key) || { name: category, count: 0 };
                    existing.count += 1;
                    existing.name = existing.name || category;
                    categoryMap.set(key, existing);
                }
            });

            const $container = $('#jobFilterContainer');
            const $buttons = $('#jobFilterButtons');

            if (categoryMap.size === 0) {
                $container.removeClass('active');
                $buttons.html('');
                return;
            }

            const totalCount = (items || []).length;
            let html = '<button class="filter-btn filter-btn-active" data-job="ALL">å…¨éƒ¨ (' + totalCount + ')</button>';
            const sortedCategories = Array.from(categoryMap.entries()).sort((a, b) => a[1].name.localeCompare(b[1].name));

            sortedCategories.forEach(([key, data]) => {
                html += '<button class="filter-btn" data-job="' + escapeHtml(key) + '">' + escapeHtml(data.name) + ' (' + data.count + ')</button>';
            });

            $buttons.html(html);
            $container.addClass('active');

            $('#jobFilterButtons .filter-btn').off('click').on('click', function () {
                const selected = $(this).data('job');
                currentJobFilter = selected;

                $('#jobFilterButtons .filter-btn').removeClass('filter-btn-active');
                $(this).addClass('filter-btn-active');

                renderResultsList(getFilteredResults());
            });
        }

        function getFilteredResults() {
            if (currentJobFilter === 'ALL') {
                return fullSearchResults;
            }

            return fullSearchResults.filter(item => {
                const category = (item.category || '').trim().toLowerCase();
                return category === currentJobFilter;
            });
        }

        function clearSearchResults() {
            $('#searchResultsPanel').hide();
            $('#resultsList').html('');
            $('#searchQuery').val('');
            fullSearchResults = [];
            currentJobFilter = 'ALL';
            $('#jobFilterContainer').removeClass('active');
            $('#jobFilterButtons').html('');
        }

        // ==================== ç‰©å“æŸ¥è©¢ ====================
        let currentItemId = null;

        function queryItemById(itemId) {
            if (!itemId) {
                itemId = $('#itemIdInput').val().trim();
            }

            if (!itemId) {
                showMessage('è«‹è¼¸å…¥ç‰©å“ ID', 'warning');
                return;
            }

            currentItemId = itemId;
            showGlobalLoading(true);
            console.log('Querying item ID:', itemId);

            // ä½¿ç”¨ XIVAPI ç²å–ç‰©å“ä¿¡æ¯
            $.ajax({
                url: 'https://xivapi.com/Item/' + encodeURIComponent(itemId),
                type: 'GET',
                dataType: 'json',
                timeout: 10000,
                success: function (response) {
                    console.log('XIVAPI item response:', response);

                    if (!response.ID) {
                        showMessage('æ‰¾ä¸åˆ°ç‰©å“ ID: ' + itemId, 'danger');
                        showGlobalLoading(false);
                        return;
                    }

                    const itemData = {
                        item: {
                            id: response.ID,
                            name: response.Name,
                            description: response.Description
                        },
                        world: state.selectedServer,
                        price: null
                    };

                    displayItemInfo(itemData);
                    showMessage('ç‰©å“ä¿¡æ¯å·²è¼‰å…¥', 'success');

                    // å˜—è©¦å¾ Universalis ç²å–åƒ¹æ ¼ï¼Œä¸¦è‡ªå‹•è¨ˆç®—åˆæˆæˆæœ¬
                    if (state.selectedServer) {
                        getItemPrice(response.ID)
                            .always(() => {
                                showGlobalLoading(false);
                                autoCalculateCraftingCost();
                            });
                    } else {
                        showGlobalLoading(false);
                    }

                    // é¡¯ç¤ºè£½é€ æˆæœ¬è¨ˆç®—é¢æ¿
                    $('#craftingCostPanel').show();
                },
                error: function (xhr, status, error) {
                    console.log('XIVAPI item error:', status, error, xhr);
                    showMessage('æŸ¥è©¢å¤±æ•—ã€‚ç‰©å“ ID å¯èƒ½ä¸å­˜åœ¨ã€‚', 'danger');
                    showGlobalLoading(false);
                }
            });
        }

        function displayItemInfo(data) {
            const item = data.item;
            const price = data.price;

            $('#itemTitle').text(item.name + ' (ID: ' + item.id + ')');
            $('#itemInfoContent').html(
                '<div class="info-row">' +
                '<span class="label">ç‰©å“åç¨±ï¼š</span>' +
                '<span class="value">' + escapeHtml(item.name) + '</span>' +
                '</div>' +
                '<div class="info-row">' +
                '<span class="label">ç‰©å“ IDï¼š</span>' +
                '<span class="value">' + item.id + '</span>' +
                '</div>' +
                '<div class="info-row">' +
                '<span class="label">ä¼ºæœå™¨ï¼š</span>' +
                '<span class="value">' + escapeHtml(data.world) + '</span>' +
                '</div>'
            );
            $('#itemInfoPanel').show();

            // ä¾ index.php é‚è¼¯è¼‰å…¥é…æ–¹è©³æƒ…ï¼Œå«å­ææ–™æˆæœ¬
            loadRecipeDetailsForItem(item.id, item.name);
        }

        function getItemPrice(itemId) {
            if (!state.selectedServer) {
                console.log('No server selected, skipping price lookup');
                return $.Deferred().resolve();
            }

            console.log('Getting price for item', itemId, 'on server', state.selectedServer);

            return $.ajax({
                url: 'https://universalis.app/api/v2/' + encodeURIComponent(state.selectedServer) + '/' + encodeURIComponent(itemId),
                type: 'GET',
                dataType: 'json',
                timeout: 10000
            }).then(function (response) {
                console.log('Universalis price response:', response);

                if (response.averagePriceNQ || response.averagePriceHQ || response.minPriceNQ || response.minPriceHQ) {
                    const price = {
                        nq_min: response.minPriceNQ ? 'âœ“ ' + response.minPriceNQ : 'ç„¡',
                        nq_avg: response.averagePriceNQ ? Math.round(response.averagePriceNQ) : 'ç„¡',
                        hq_min: response.minPriceHQ ? 'âœ“ ' + response.minPriceHQ : 'ç„¡',
                        hq_avg: response.averagePriceHQ ? Math.round(response.averagePriceHQ) : 'ç„¡'
                    };

                    // ç·©å­˜æˆå“å¸‚å ´åƒ¹ï¼Œä¾›æˆæœ¬å€å¡Šé¡¯ç¤º
                    state.lastItemPriceData = price;

                    $('#priceContent').html(
                        '<div class="price-row">' +
                        '<div class="price-type">NQ (Normal Quality)</div>' +
                        '<div>æœ€ä½: <strong>' + price.nq_min + '</strong> é‡‘å¹£</div>' +
                        '<div>å¹³å‡: <strong>' + price.nq_avg + '</strong> é‡‘å¹£</div>' +
                        '</div>' +
                        '<div class="price-row">' +
                        '<div class="price-type">HQ (High Quality)</div>' +
                        '<div>æœ€ä½: <strong>' + price.hq_min + '</strong> é‡‘å¹£</div>' +
                        '<div>å¹³å‡: <strong>' + price.hq_avg + '</strong> é‡‘å¹£</div>' +
                        '</div>'
                    );
                    $('#pricePanel').show();
                } else {
                    console.log('No price data available');
                }
            }).catch(function (xhr, status, error) {
                console.log('Universalis error:', status, error);
            });
        }

        function clearItemInfo() {
            $('#itemInfoPanel').hide();
            $('#pricePanel').hide();
            $('#craftPanel').hide();
            $('#craftContent').html('');
            $('#craftingCostPanel').hide();
            $('#itemIdInput').val('');
            currentItemId = null;
            state.lastItemPriceData = null;
        }

        // ==================== è£½é€ æˆæœ¬è¨ˆç®— ====================

        function calculateCraftingCost() {
            if (!currentItemId) {
                showMessage('è«‹å…ˆæŸ¥è©¢ç‰©å“', 'warning');
                return;
            }

            const quantity = parseInt($('#craftQuantity').val()) || 1;

            if (!state.selectedServer) {
                showMessage('è«‹é¸æ“‡ä¼ºæœå™¨', 'warning');
                return;
            }

            showGlobalLoading(true);
            console.log('Calculating crafting cost for item:', currentItemId, 'quantity:', quantity);

            // å…ˆå¾ XIVAPI ç²å–é£Ÿè­œä¿¡æ¯
            $.ajax({
                url: 'https://xivapi.com/Item/' + currentItemId,
                type: 'GET',
                dataType: 'json',
                timeout: config.timeout,
                success: function (itemResponse) {
                    console.log('Item response:', itemResponse);

                    if (!itemResponse.Recipes || itemResponse.Recipes.length === 0) {
                        showMessage('æ‰¾ä¸åˆ°è©²ç‰©å“çš„é£Ÿè­œ', 'warning');
                        showGlobalLoading(false);
                        return;
                    }

                    const recipeId = itemResponse.Recipes[0].ID;
                    console.log('Found recipe ID:', recipeId);

                    // ç²å–é£Ÿè­œè©³ç´°ä¿¡æ¯
                    $.ajax({
                        url: 'https://xivapi.com/Recipe/' + recipeId,
                        type: 'GET',
                        dataType: 'json',
                        timeout: config.timeout,
                        success: function (recipeResponse) {
                            console.log('Recipe details:', recipeResponse);
                            calculateAndDisplayCost(recipeResponse, quantity);
                            showGlobalLoading(false);
                        },
                        error: function (xhr, status, error) {
                            console.log('Recipe details error:', status, error);
                            showGlobalLoading(false);
                            showMessage('ç²å–é£Ÿè­œè©³æƒ…å¤±æ•—', 'danger');
                        }
                    });
                },
                error: function (xhr, status, error) {
                    console.log('Item lookup error:', status, error);
                    showGlobalLoading(false);
                    showMessage('æŸ¥è©¢ç‰©å“å¤±æ•—ï¼š' + error, 'danger');
                }
            });
        }

        // è‡ªå‹•è¨ˆç®—åˆæˆæˆæœ¬ï¼ˆåœ¨æœ‰ä¼ºæœå™¨ä¸”å·²æœ‰ currentItemId æ™‚è§¸ç™¼ï¼‰
        function autoCalculateCraftingCost() {
            if (!state.selectedServer) {
                return;
            }
            if (!currentItemId) {
                return;
            }
            // ä½¿ç”¨ç•¶å‰è¼¸å…¥çš„æ•¸é‡ï¼ˆé è¨­ 1ï¼‰
            calculateCraftingCost();
        }

        function calculateAndDisplayCost(recipe, quantity) {
            if (!recipe) {
                showMessage('ç„¡æ•ˆçš„é£Ÿè­œä¿¡æ¯', 'danger');
                return;
            }

            const ingredients = [];
            let totalCost = 0;

            // æå–ææ–™åˆ—è¡¨
            for (let i = 0; i <= 9; i++) {
                const ingredientKey = 'ItemIngredient' + i;
                const amountKey = 'AmountIngredient' + i;

                if (recipe[ingredientKey] && recipe[ingredientKey].ID) {
                    const itemId = recipe[ingredientKey].ID;
                    const requiredAmount = (recipe[amountKey] || 0) * quantity;
                    const icon = recipe[ingredientKey].IconHD || recipe[ingredientKey].Icon || null;

                    if (requiredAmount > 0) {
                        ingredients.push({
                            id: itemId,
                            name: recipe[ingredientKey].Name || 'æœªçŸ¥',
                            requiredAmount: requiredAmount,
                            unitPrice: 0,
                            icon: icon
                        });
                    }
                }
            }

            if (ingredients.length === 0) {
                showMessage('ç„¡æ³•è§£æé£Ÿè­œææ–™', 'warning');
                return;
            }

            console.log('Ingredients found:', ingredients);

            // æ‰¹é‡æŸ¥è©¢ææ–™åƒ¹æ ¼
            const itemIds = ingredients.map(i => i.id).join(',');
            $.ajax({
                url: 'https://universalis.app/api/v2/aggregated/' + encodeURIComponent(state.selectedServer) + '/' + itemIds,
                type: 'GET',
                dataType: 'json',
                timeout: config.timeout,
                success: function (priceResponse) {
                    console.log('Price response:', priceResponse);

                    // æ›´æ–°ææ–™åƒ¹æ ¼
                    if (priceResponse.results) {
                        priceResponse.results.forEach(function (result) {
                            const itemId = result.itemID || result.itemId;
                            const ingredient = ingredients.find(i => i.id === itemId);

                            if (ingredient && result.nq) {
                                // ä½¿ç”¨ NQ æœ€ä½åƒ¹æ ¼æˆ–å¹³å‡åƒ¹æ ¼
                                const unit = result.nq.minListing?.world?.price ||
                                    result.nq.averageSalePrice?.world?.price || 0;
                                ingredient.unitPrice = roundPrice(unit);
                                totalCost += ingredient.unitPrice * ingredient.requiredAmount;
                            }
                        });
                    }

                    // é¡¯ç¤ºçµæœ
                    totalCost = roundPrice(totalCost);
                    const costPerUnit = quantity > 0 ? roundPrice(totalCost / quantity) : 0;
                    displayCraftingCost({
                        ingredients: ingredients,
                        totalCost: totalCost,
                        costPerUnit: costPerUnit
                    });
                    showMessage('æˆæœ¬è¨ˆç®—å®Œæˆ', 'success');
                },
                error: function (xhr, status, error) {
                    console.log('Price lookup error:', status, error);
                    showMessage('ç„¡æ³•ç²å–ææ–™åƒ¹æ ¼ï¼Œè«‹ç¨å¾Œé‡è©¦', 'warning');

                    // ä»ç„¶é¡¯ç¤ºææ–™åˆ—è¡¨ï¼Œä½†åƒ¹æ ¼ç‚º 0
                    const costPerUnit = 0;
                    displayCraftingCost({
                        ingredients: ingredients,
                        totalCost: 0,
                        costPerUnit: costPerUnit
                    });
                }
            });
        }

        function displayCraftingCost(data) {
            let html = '';

            if (data.ingredients && data.ingredients.length > 0) {
                html += '<h4 style="margin-bottom: 1rem; color: var(--primary);">ğŸ“¦ æ‰€éœ€ææ–™</h4>';
                html += '<div style="overflow-y: auto; max-height: 300px; margin-bottom: 1.5rem;">';

                data.ingredients.forEach(function (ingredient) {
                    const totalCost = roundPrice((ingredient.unitPrice || 0) * ingredient.requiredAmount);
                    const iconUrl = getIconUrl(ingredient.icon);
                    html += '<div style="display: flex; justify-content: space-between; padding: 0.5rem; border-bottom: 1px solid var(--border-color);">';
                    html += '<div style="display:flex; align-items:center; gap:0.5rem;">';
                    html += '<img src="' + iconUrl + '" alt="' + escapeHtml(ingredient.name) + ' icon" style="width:36px; height:36px; border-radius:0.5rem; border:1px solid var(--border-color); object-fit: cover; background:#e9ecef;">';
                    html += '<div>';
                    html += '<strong>' + escapeHtml(ingredient.name) + '</strong><br>';
                    html += '<small style="color: var(--gray);">æ•¸é‡: ' + ingredient.requiredAmount + ' | å–®åƒ¹: ' + (ingredient.unitPrice || '0') + ' G</small>';
                    html += '</div>';
                    html += '</div>';
                    html += '<div style="text-align: right;">';
                    html += '<strong>' + totalCost.toLocaleString() + ' G</strong>';
                    html += '</div>';
                    html += '</div>';
                });

                html += '</div>';
            }

            html += '<div style="background: #e8f4f8; padding: 1rem; border-radius: 0.375rem; margin-top: 1rem;">';
            html += '<div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">';
            html += '<span>ç¸½æˆæœ¬ï¼š</span>';
            html += '<strong style="color: var(--danger);">' + (data.totalCost || 0).toLocaleString() + ' G</strong>';
            html += '</div>';
            html += '<div style="display: flex; justify-content: space-between;">';
            html += '<span>å¹³å‡æˆæœ¬ï¼ˆå–®ä½ï¼‰ï¼š</span>';
            html += '<strong style="color: var(--primary);">' + (data.costPerUnit || 0).toLocaleString() + ' G</strong>';
            html += '</div>';
            html += '</div>';

            // é¡¯ç¤ºæˆå“å¸‚å ´åƒ¹ (ä½¿ç”¨ç·©å­˜çš„åƒ¹æ ¼æ•¸æ“š)
            if (state.lastItemPriceData) {
                html += '<div style="background: #fff9e6; padding: 1rem; border-radius: 0.375rem; margin-top: 0.75rem; border: 1px solid var(--border-color);">';
                html += '<div style="font-weight: 600; margin-bottom: 0.5rem;">æˆå“å¸‚å ´åƒ¹ï¼ˆ' + escapeHtml(state.selectedServer || '-') + 'ï¼‰</div>';
                html += '<div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">';
                html += '<span>NQ æœ€ä½ / å¹³å‡ï¼š</span>';
                html += '<strong>' + escapeHtml(state.lastItemPriceData.nq_min) + ' / ' + escapeHtml(state.lastItemPriceData.nq_avg) + ' G</strong>';
                html += '</div>';
                html += '<div style="display: flex; justify-content: space-between;">';
                html += '<span>HQ æœ€ä½ / å¹³å‡ï¼š</span>';
                html += '<strong>' + escapeHtml(state.lastItemPriceData.hq_min) + ' / ' + escapeHtml(state.lastItemPriceData.hq_avg) + ' G</strong>';
                html += '</div>';
                html += '</div>';
            }

            $('#craftingCostContent').html(html);
            $('#craftingCostPanel').show();
            showMessage('æˆæœ¬è¨ˆç®—å®Œæˆ', 'success');
        }

        // ==================== åˆæˆè¡¨ï¼ˆå«å­ææ–™æˆæœ¬ï¼‰ ====================
        async function loadRecipeDetailsForItem(itemId, itemName) {
            console.log('loadRecipeDetailsForItem', itemId, itemName);
            $('#craftPanel').hide();
            $('#craftContent').html('');

            if (!itemId) {
                return;
            }

            // æ²’é¸ä¼ºæœå™¨æ™‚ï¼Œåªé¡¯ç¤ºé…æ–¹çµæ§‹ä¸ç®—æˆæœ¬
            const hasServer = Boolean(state.selectedServer);

            try {
                showGlobalLoading(true);

                // å…ˆå–å¾—ç‰©å“å¯ç”¨çš„é…æ–¹åˆ—è¡¨ï¼Œå–ç¬¬ä¸€å€‹
                const itemResponse = await $.ajax({
                    url: config.xivApiUrl + '/Item/' + encodeURIComponent(itemId),
                    type: 'GET',
                    dataType: 'json',
                    timeout: config.timeout
                });

                const recipes = (itemResponse && itemResponse.Recipes) || [];
                if (!recipes.length) {
                    console.log('No recipes for item', itemId);
                    return;
                }

                const primaryRecipeId = recipes[0].ID;
                const recipeDetail = await fetchRecipeDetail(primaryRecipeId);
                const recipeCost = await buildRecipeCost(recipeDetail, hasServer);

                // å–å¾—æ¯å€‹ææ–™çš„å­é…æ–¹èˆ‡æˆæœ¬ï¼ˆè‹¥æœ‰ï¼‰
                await attachSubRecipeCosts(recipeCost.ingredients, hasServer);

                renderRecipeDetails(recipeDetail, recipeCost, itemName);
            } catch (error) {
                console.warn('loadRecipeDetailsForItem error', error);
                showMessage('è¼‰å…¥é…æ–¹è©³æƒ…å¤±æ•—', 'warning');
            } finally {
                showGlobalLoading(false);
            }
        }

        async function fetchRecipeDetail(recipeId) {
            return $.ajax({
                url: config.xivApiUrl + '/Recipe/' + encodeURIComponent(recipeId),
                type: 'GET',
                dataType: 'json',
                timeout: config.timeout
            });
        }

        function collectIngredients(recipeDetail) {
            const ingredients = [];
            for (let i = 0; i <= 9; i++) {
                const item = recipeDetail['ItemIngredient' + i];
                const amount = recipeDetail['AmountIngredient' + i];
                if (item && item.ID && amount > 0) {
                    ingredients.push({
                        id: item.ID,
                        name: item.Name || 'æœªçŸ¥',
                        amount: amount,
                        icon: item.IconHD || item.Icon || null,
                        unitPrice: 0,
                        totalCost: 0,
                        subRecipe: null
                    });
                }
            }
            return ingredients;
        }

        async function getAggregatedPrices(itemIds) {
            if (!itemIds || !itemIds.length || !state.selectedServer) {
                return null;
            }

            try {
                const response = await $.ajax({
                    url: 'https://universalis.app/api/v2/aggregated/' + encodeURIComponent(state.selectedServer) + '/' + itemIds.join(','),
                    type: 'GET',
                    dataType: 'json',
                    timeout: config.timeout
                });
                return response.results || [];
            } catch (err) {
                console.warn('Aggregated price fetch failed', err);
                return null;
            }
        }

        async function buildRecipeCost(recipeDetail, hasServer) {
            const ingredients = collectIngredients(recipeDetail);
            const itemIds = ingredients.map(i => i.id);
            let priceMap = {};

            if (hasServer) {
                const aggResults = await getAggregatedPrices(itemIds);
                if (aggResults) {
                    aggResults.forEach(res => {
                        const id = res.itemID || res.itemId;
                        const unit = res.nq?.minListing?.world?.price || res.nq?.averageSalePrice?.world?.price || res.minPriceNQ || 0;
                        priceMap[id] = roundPrice(unit);
                    });
                }
            }

            let totalCost = 0;
            ingredients.forEach(ing => {
                ing.unitPrice = roundPrice(priceMap[ing.id]);
                ing.totalCost = roundPrice(ing.unitPrice * ing.amount);
                totalCost += ing.totalCost;
            });

            const yields = recipeDetail.AmountResult || recipeDetail.AmountResultHQ || 1;
            totalCost = roundPrice(totalCost);
            const costPerUnit = yields > 0 ? roundPrice(totalCost / yields) : totalCost;

            return {
                recipe: {
                    id: recipeDetail.ID,
                    classJob: (recipeDetail.ClassJob && (recipeDetail.ClassJob.Abbreviation || recipeDetail.ClassJob.Name)) || '-',
                    level: (recipeDetail.RecipeLevelTable && (recipeDetail.RecipeLevelTable.ClassJobLevel || recipeDetail.RecipeLevelTable.Name)) || '-',
                    difficulty: recipeDetail.Difficulty || '-',
                    durability: recipeDetail.Durability || '-',
                    resultItem: {
                        id: recipeDetail.ItemResult?.ID || '',
                        name: recipeDetail.ItemResult?.Name || 'æˆå“'
                    }
                },
                ingredients,
                totalCost,
                yields,
                costPerUnit
            };
        }

        async function fetchSubRecipeCost(itemId, hasServer) {
            try {
                const itemResponse = await $.ajax({
                    url: config.xivApiUrl + '/Item/' + encodeURIComponent(itemId),
                    type: 'GET',
                    dataType: 'json',
                    timeout: config.timeout
                });
                const recipes = (itemResponse && itemResponse.Recipes) || [];
                if (!recipes.length) return null;

                const recipeDetail = await fetchRecipeDetail(recipes[0].ID);
                return await buildRecipeCost(recipeDetail, hasServer);
            } catch (err) {
                console.warn('fetchSubRecipeCost error for', itemId, err);
                return null;
            }
        }

        async function attachSubRecipeCosts(ingredients, hasServer) {
            for (const ing of ingredients) {
                const subCost = await fetchSubRecipeCost(ing.id, hasServer);
                if (subCost) {
                    ing.subRecipe = subCost;
                }
            }
        }

        function renderRecipeDetails(recipeDetail, recipeCost, itemName) {
            const headerName = itemName || recipeCost.recipe.resultItem.name;
            let html = '';

            html += '<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1.25rem; border-radius: 0.75rem; margin-bottom: 1rem;">';
            html += '<h4 style="margin:0 0 0.5rem 0;">' + escapeHtml(headerName) + '</h4>';
            html += '<div style="display:flex; gap:1rem; flex-wrap:wrap; font-size:0.9rem; opacity:0.9;">';
            html += '<span>è·æ¥­: ' + escapeHtml(recipeCost.recipe.classJob) + '</span>';
            html += '<span>ç­‰ç´š: ' + escapeHtml(recipeCost.recipe.level) + '</span>';
            html += '<span>é›£åº¦: ' + escapeHtml(recipeCost.recipe.difficulty) + '</span>';
            html += '<span>è€ä¹…: ' + escapeHtml(recipeCost.recipe.durability) + '</span>';
            html += '<span>ç”¢å‡º: x' + recipeCost.yields + '</span>';
            html += '</div>';
            html += '</div>';

            html += '<div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 1rem; margin-bottom: 1rem;">';
            html += '<div style="background:#f8f9fa; padding:1rem; border-radius:0.5rem; border-left:4px solid #28a745;">';
            html += '<div style="font-size:0.9rem; color:#666;">è£½ä½œç¸½æˆæœ¬</div>';
            html += '<div style="font-size:1.4rem; font-weight:700; color:#28a745;">' + recipeCost.totalCost.toLocaleString() + ' G</div>';
            html += '<div style="font-size:0.85rem; color:#555;">å–®å€‹: ' + recipeCost.costPerUnit.toLocaleString() + ' G</div>';
            html += '</div>';
            html += '<div style="background:#f8f9fa; padding:1rem; border-radius:0.5rem; border-left:4px solid #007bff;">';
            html += '<div style="font-size:0.9rem; color:#666;">æˆå“</div>';
            html += '<div style="font-size:1.1rem; font-weight:700; color:#007bff;">' + escapeHtml(recipeCost.recipe.resultItem.name) + ' x' + recipeCost.yields + '</div>';
            html += '</div>';
            html += '</div>';

            html += '<h5 style="margin:0 0 0.5rem 0;">æ‰€éœ€ææ–™åŠæˆæœ¬</h5>';
            html += '<div style="display:grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap:0.75rem;">';

            recipeCost.ingredients.forEach(ing => {
                const iconUrl = getIconUrl(ing.icon);
                html += '<div style="background:white; border:1px solid #e5e7eb; border-radius:0.75rem; padding:0.9rem; box-shadow:0 2px 4px rgba(0,0,0,0.06);">';
                html += '<div style="display:flex; align-items:center; gap:0.75rem;">';
                html += '<img src="' + iconUrl + '" alt="' + escapeHtml(ing.name) + ' icon" style="width:42px; height:42px; border-radius:0.5rem; border:1px solid var(--border-color); object-fit:cover; background:#e9ecef;">';
                html += '<div style="flex:1;">';
                html += '<div style="font-weight:700;">' + escapeHtml(ing.name) + '</div>';
                html += '<div style="color:#666; font-size:0.9rem;">éœ€è¦ x' + ing.amount + '</div>';
                html += '</div>';
                html += '</div>';

                html += '<div style="margin-top:0.5rem; padding-top:0.5rem; border-top:1px solid #f0f0f0; font-size:0.95rem; color:#333;">';
                html += '<div style="display:flex; justify-content:space-between; margin-bottom:0.25rem;">';
                html += '<span>å¸‚å ´å–®åƒ¹</span>';
                html += '<strong style="color:#0066cc;">' + (ing.unitPrice || 0).toLocaleString() + ' G</strong>';
                html += '</div>';
                html += '<div style="display:flex; justify-content:space-between;">';
                html += '<span>è³¼è²·å°è¨ˆ</span>';
                html += '<strong style="color:#e74c3c;">' + (ing.totalCost || 0).toLocaleString() + ' G</strong>';
                html += '</div>';
                html += '</div>';

                if (ing.subRecipe) {
                    const sub = ing.subRecipe;
                    const subUnit = roundPrice(sub.costPerUnit || 0);
                    const craftTotal = roundPrice(subUnit * ing.amount);
                    const saving = roundPrice((ing.totalCost || 0) - craftTotal);
                    const subTotal = roundPrice(sub.totalCost || 0);
                    const savingColor = saving > 0 ? '#28a745' : '#dc3545';
                    const savingLabel = saving > 0 ? 'è£½ä½œçœ' : (saving < 0 ? 'è³¼è²·çœ' : 'æŒå¹³');

                    html += '<div style="margin-top:0.6rem; padding:0.65rem; background:#f8f9fa; border-radius:0.5rem; border-left:3px solid #28a745;">';
                    html += '<div style="font-weight:700; font-size:0.95rem; color:#28a745; margin-bottom:0.35rem;">å¯è£½ä½œï¼š' + escapeHtml(sub.recipe.resultItem.name) + ' x' + sub.yields + '</div>';
                    html += '<div style="display:flex; justify-content:space-between; font-size:0.9rem; margin-bottom:0.25rem;">';
                    html += '<span>å­é…æ–¹ç¸½æˆæœ¬</span><strong>' + subTotal.toLocaleString() + ' G</strong>';
                    html += '</div>';
                    html += '<div style="display:flex; justify-content:space-between; font-size:0.9rem; margin-bottom:0.25rem;">';
                    html += '<span>å­é…æ–¹å–®å€‹æˆæœ¬</span><strong>' + subUnit.toLocaleString() + ' G</strong>';
                    html += '</div>';
                    html += '<div style="display:flex; justify-content:space-between; font-size:0.9rem; color:' + savingColor + '; font-weight:700;">';
                    html += '<span>' + savingLabel + '</span><span>' + Math.abs(saving).toLocaleString() + ' G</span>';
                    html += '</div>';

                    if (sub.ingredients && sub.ingredients.length > 0) {
                        html += '<div style="margin-top:0.5rem; font-size:0.85rem; color:#555;">å­ææ–™ï¼š</div>';
                        sub.ingredients.forEach(subIng => {
                            const subIcon = getIconUrl(subIng.icon);
                            html += '<div style="display:flex; align-items:center; justify-content:space-between; gap:0.35rem; padding:0.2rem 0;">';
                            html += '<div style="display:flex; align-items:center; gap:0.35rem;">';
                            html += '<img src="' + subIcon + '" style="width:20px; height:20px; border-radius:0.35rem; border:1px solid #e5e7eb; background:#f1f3f5; object-fit:cover;">';
                            html += '<span>' + escapeHtml(subIng.name) + ' x' + subIng.amount + '</span>';
                            html += '</div>';
                            html += '<span style="color:#0066cc; font-weight:600;">' + (subIng.totalCost || 0).toLocaleString() + ' G</span>';
                            html += '</div>';
                        });
                    }

                    html += '</div>';
                }

                html += '</div>';
            });

            html += '</div>';

            $('#craftContent').html(html);
            $('#craftPanel').show();
        }

        // ==================== UI è¼”åŠ©å‡½æ•¸ ====================
        function showGlobalLoading(show) {
            if (show) {
                $('#globalLoading').show();
            } else {
                $('#globalLoading').hide();
            }
            state.isLoading = show;
        }

        function getIconUrl(iconPath) {
            if (!iconPath) {
                return DEFAULT_ICON;
            }
            if (iconPath.startsWith('http')) {
                return iconPath;
            }
            return config.xivApiUrl + iconPath;
        }

        function roundPrice(value) {
            const num = Number(value) || 0;
            return Math.round(num);
        }

        function showMessage(msg, type) {
            type = type || 'info';
            const typeMap = {
                'danger': 'alert-danger',
                'success': 'alert-success',
                'warning': 'alert-warning',
                'info': 'alert-info'
            };

            const $container = $('#messageContainer');
            const alertClass = typeMap[type] || 'alert-info';
            const $alert = $('<div class="alert ' + alertClass + '">' + escapeHtml(msg) + '</div>');

            $container.append($alert);
            setTimeout(function () {
                $alert.fadeOut(function () {
                    $alert.remove();
                });
            }, 4000);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }


    </script>
</body>

</html>